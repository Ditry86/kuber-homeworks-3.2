# Домашнее задание к занятию «Установка Kubernetes»

Данный репозиторий содержит практическое решение для задания к занятию «Установка Kubernetes».

В ходе реализации проекта в облаке Yandex создаются: VPC; 5 виртуальные машины (ноды) в облаке Yandex для реализации HA кластера.

## Содержание проекта

1. Каталог `terraform`. Структура файлов terraform для создания ВМ нод и соответствующего окружения в облаке Yandex:
  - Файл описания создаваемых инстансов (ВМ) - `instances.tf`;
  - Файл описания переменных (входные, выходные) - `vars.tf`;
  - Файл поисания VPC - `vpc.tf`;
  - Файл описания провайдера, облачного образа установки ОС - `version.tf`.
2. Каталог `kubspray`. Структура файлов ansible для настройки нод и установки ПО на них:
3. Каталог auto. Файлы bash-скриптов для автоматизации выполнения операций по реализации задач проекта:
4. Корневой каталог так же содержит:
  - `Makefile` - make-файл с инструкциями для запуска bash-скриптов и добавления env var's, необходимых для работы yc, terraform, ansible;
  - `init.conf.example` - файл-шаблон конфигурации для автоматизации шагов по решению заданий проекта;
  - `yandex_provider.example` - файл-шаблон конфигурации провайдера yandex для terraform.

Для создания HA кластера Kubernetes в данном проекте выбрана следующая конфигурация: master ноды (включют etcd, нечетное количество), worker ноды, ingress ноды. В качестве балансировщика кластера используетя - локальный LB кластера, предлагаемый kubeproxy по-умолчанию.

В нашем случае для реализации кластера было выбрано следующее количество нод:
1. Master (+etcd) - 3 ноды
2. Worker - 2 ноды
3. Ingress - 1 нода

Все настройки для настройки нод и кластера устанавливаются при помощи переменных kubespray в каталогах kubspray/inventory/mycluster.
Все этапы развертки среды и нод кластера можно реализовать при помощи команд Makefile:
1. make install - установка необходимого ПО на локальном хосте (control node)
2. make prepare - настройка локального ПО для развертки инфраструктуры в облаке для кластера
3. make deploy - развертка инфраструктуры в облаке (ВМ,VPC)
4. make kuberspray - настройка нод,создание кластера Kubernetes

Для работы автоматической развертки кластера необходимо в корне проекта создать файл init.conf на основе шаблона init.conf.example.
В котором указывается:

```
oa_token - токен YAndex Autority
cloud_id - ID вашего облака
folder_id - ID вашего каталога облака 
zone  - зона облака
service_account - сервис аккаунт облака
masters - количество master нод
workers - количество worker нод
ingress - количество нод ingress-контроллера
```

После отработки всех этапов развертки кластера, в каталоге kubspray/inventory/mycluster/artifacts должен появиться файл конфигурации для работы утилиты kubectl с кластером. Данный файл необходимо скопировать по пути ~/.kube/config. После чего в строке файла конфигурации ~/.kube/config поменять IP подключения к кластеру на внешний IP любой master ноды. IP можно получить с помощью команды `cd terraform && terraform output`.

<br>

## Проверка работы кластера

Вывод команды 'kubectl get nodes`

```
kubectl get nodes
NAME        STATUS   ROLES                   AGE   VERSION
ingress-1   Ready    ingress                 48m   v1.29.3
master-1    Ready    control-plane,ingress   49m   v1.29.3
master-2    Ready    control-plane,ingress   49m   v1.29.3
master-3    Ready    control-plane,ingress   49m   v1.29.3
worker-1    Ready    ingress                 48m   v1.29.3
worker-2    Ready    ingress                 48m   v1.29.3
```